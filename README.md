# alluxio-nginx-s3-proxy
Use Nginx to expose the Alluxio S3 API to client apps like Teradata NOS and Vertica

## Background

Alluxio is a powerful tool for bringing data closer to your compute workloads, with a unifield namespace, many application APIs, many data source APIs, local caching and policy based data management capabilities, Alluxio can:

- help reduce costs by reducing data copies and cloud storage egress costs
- increase performance by caching data close to the user workloads
- provide a heterogeneous data environment where users do not have to know where the data is stored

See: https://docs.alluxio.io/os/user/stable/en/Overview.html

One method that end-users and applications use to submit read/write requests to Alluxio is to use the Alluxio S3 API. The Alluxio S3 API uses an S3 "endpoint" that includes an API version specification like this:

     http://alluxio-s3-api-server-hostname:39999/api/v1/s3/my_bucket/my_dataset

That S3 endpoint is used by S3 clients when they connect to the Alluxio S3 API. For example, a Spark program can connect to Alluxio using the Alluxio S3 endpoint like this:

     import org.apache.spark.sql.SparkSession

     val spark = SparkSession.builder()
	                 .appName("Scala Alluxio S3 Example")
	                 .config("spark.serializer", "org.apache.spark.serializer.KryoSerializer")
	                 .master("spark://<spark-master-host>:7077").getOrCreate()

     val sc=spark.sparkContext
     
     sc.hadoopConfiguration.set("fs.s3a.endpoint", http://<alluxio-s3-api-host>:39999/api/v1/s3)

     sc.hadoopConfiguration.set("fs.s3a.impl", "org.apache.hadoop.fs.s3a.S3AFileSystem")
     sc.hadoopConfiguration.set("fs.s3a.access.key", "<ACCESS_KEY>")
     sc.hadoopConfiguration.set("fs.s3a.secret.key", "<SECRET_KEY>")
     sc.hadoopConfiguration.set("fs.s3a.path.style.access", "true")
     sc.hadoopConfiguration.set("fs.s3a.connection.ssl.enabled","false")
     
     val df = sc.read.parquet("s3a://data/tpcds/store_sales/part-00946-c5618d03-1901-4cd6-b0c4-ec9aaa5b252c-c000.snappy.parquet")

     ...

Some query engines, including Teradata NOS and Vertica, do not allow users to specify the S3 endpoint as a property, and they do not expect to see an API version in the S3 URI (i.e. /api/v1/s3/). 

Alluxio has an open JIRA ticket requesting a change to the Alluxio endpoint specification, but until that change is implemented Alluxio customers can use this BASH script in this Git repo to deploy an Nginx proxy server that translates the S3 URI that is generated by Teradata and Vertica into an S3 URI that works with the Alluxio S3 API.  It will convert this:

     http://<alluxio-s3-api-host>:39998/my_bucket/my_dataset
     
to this:

     http://<alluxio-s3-api-host>:39999/api/v1/s3/my_bucket/my_dataset

## Deploying Nginx as an Alluxio S3 proxy

### Step 1. Install and configure Nginx on Alluxio workers

Run the install-alluxio-s3-proxy-server-on-worker.sh BASH script on each Alluxio worker node where the current Alluxio S3 API server is running.

a. On each Alluxio worker node, download and run the BASH script: 

     wget https://raw.githubusercontent.com/gregpalmr/alluxio-nginx-s3-proxy/main/install-alluxio-s3-proxy-server-on-worker.sh
     
     sudo bash install-alluxio-s3-proxy-server-on-worker.sh
     
b. View the Nginx configuration file that was saved in the Alluxio conf directory:

     cat $ALLUXIO_HOME/conf/alluxio-s3-proxy.conf

c. Start the Nginx server using the custom start script:

     $ALLUXIO_HOME/bin/alluxio-start-s3-proxy.sh
     

d. Test the Nginx proxy server.

Use the curl command to issue an HTTP request that invokes the Nginx proxy so it can forward the request to the real Alluxio S3 API service. Something like this:

     curl -i --output ./part_00000.snappy.parquet \
         -H \"Authorization: AWS4-HMAC-SHA256 Credential=<my_alluxio_user>/\" \
         -X GET http://<alluxio-worker-node>:39998/my_bucket/my_data_set/part_00000.snappy.parquet

Step 2. Create a database table that points to the Alluxio S3 bucket

TBD
--

Please direct questions or comments to greg.palmer@alluxio.com
